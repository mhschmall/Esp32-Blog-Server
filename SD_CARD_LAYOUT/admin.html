<!DOCTYPE html>
<html lang="en">
<head>
<title>Blog Admin</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
body { margin: 0; font-family: Arial, Helvetica, sans-serif; }

/* Top navigation bar */
.topnav { overflow: hidden; background-color: #333; }
.topnav a { float: left; display: block; color: #f2f2f2; text-align: center;
  padding: 14px 16px; text-decoration: none; }
.topnav a:hover { background-color: #ddd; color: black; }

/* Content area */
.content { background-color: #f9f9f9; padding: 20px; min-height: 400px; }
form { background: white; padding: 15px; border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
form input[type="text"], form textarea {
  width: 100%; padding: 8px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px;
}

/* Reusable button style */
.btn-primary { padding: 10px 15px; background-color: #333; color: white;
  border: none; border-radius: 4px; cursor: pointer; }
.btn-primary:hover { background-color: #555; }

/* Entry/message list */
.entry, .message {
  background: white; padding: 15px; margin-bottom: 15px;
  border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.entry h3, .message h3 { margin: 0; }
.entry button, .message button {
  margin-right: 10px; margin-top: 10px; padding: 6px 12px;
  border: none; border-radius: 4px; cursor: pointer;
}
.delete-btn { background-color: #b33; color: white; }
.edit-btn { background-color: #337ab7; color: white; }
.delete-btn:hover { background-color: #d44; }
.edit-btn:hover { background-color: #559ed6; }

/* Pagination */
#pagination { text-align: center; margin-top: 20px; }
#pagination button {
  margin: 0 5px; padding: 8px 14px; border: none; border-radius: 4px;
  background-color: #333; color: white; cursor: pointer;
}
#pagination button:disabled { background-color: #aaa; cursor: not-allowed; }
#pageIndicator { display: block; margin-top: 10px; font-size: 14px; color: #555; }

/* Footer */
.footer { background-color: #ddd; padding: 10px; text-align: center; }

/* Modal editor */
#editModal {
  display: none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.6);
  align-items: center; justify-content: center; z-index: 1000;
}
#editModalContent {
  background: #fff; padding: 20px; border-radius: 6px;
  width: 90%; max-width: 600px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div class="topnav">
  <a href="/">Blog</a>
  <a href="/admin">Admin</a>
  <a href="/shutdown">Off</a>
  <a href="/logout">Logout</a>
</div>

<div class="content">
  <h2>Add New Blog Entry</h2>
  <form id="uploadForm">
    <input type="text" name="title" placeholder="Title" required>
    <textarea name="content" placeholder="Write your post...html is fine, just NO quotes." rows="5" required></textarea>
    <input type="hidden" name="action" value="upload">
    <button type="submit" class="btn-primary">Upload Entry</button>
  </form>

  <h2>Data Management</h2>
  <button id="exportBtn" class="btn-primary">Export All Entries</button>
  <form id="importForm" enctype="multipart/form-data" style="margin-top:15px;">
    <input type="file" id="importFile" name="file" accept=".json" required>
    <button type="submit" class="btn-primary">Import Entries</button> 
    WARNING! This will OVERWRITE your current entries.json file. Use Export All first! You were warned.
  </form> 

  <h2>Manage</h2>
  <div>
    <button id="manageEntriesBtn" class="btn-primary">Manage Entries</button>
    <button id="manageMessagesBtn" class="btn-primary">Manage Messages</button>
  </div><p>
  <div id="dataContainer"></div>

  <div id="pagination">
    <button id="prevBtn">Prev</button>
    <button id="nextBtn">Next</button>
    <span id="pageIndicator"></span>
  </div>
</div>

<div class="footer">
  <p id="footerText"></p>
</div>

<!-- Edit Modal (entries only) -->
<div id="editModal">
  <div id="editModalContent">
    <h3>Edit Blog Entry</h3>
    <form id="editForm">
      <input type="hidden" name="id" id="editId">
      <input type="text" id="editTitle" placeholder="Title" required>
      <textarea id="editContent" rows="10" style="width:100%; padding:10px; margin:10px 0;
        border:1px solid #ccc; border-radius:4px;" required></textarea>
      <div style="text-align:right;">
        <button type="button" onclick="closeEditModal()" class="btn-primary" style="background:#777;">Cancel</button>
        <button type="submit" class="btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
let start = 0;
const pageSize = 5;
let currentPage = 1;
let totalPages = 1;
let pageServed = 1;
let currentView = "entries"; // "entries" or "messages"

async function fetchPageServed() {
  const res = await fetch("/pagecount");
  const data = await res.json();
  pageServed = data.pagecount || 0;
  document.getElementById("footerText").textContent =
    `${pageServed} pages served, Copyright 2025 @Spiffy Productions`;
}

// count for entries only
async function fetchTotalPages() {
  if (currentView === "entries") {
    const res = await fetch("/count");
    const data = await res.json();
    const totalEntries = data.total || 0;
    totalPages = Math.max(1, Math.ceil(totalEntries / pageSize));
  } else {
    const res = await fetch("/messages?all=true");
    const data = await res.json();
    const list = data.messages || [];
    const total = list.length;
    totalPages = Math.max(1, Math.ceil(total / pageSize));
  }
}

async function fetchEntries() {
  const res = await fetch(`/entries?start=${start}`);
  const data = await res.json();
  const container = document.getElementById("dataContainer");
  container.innerHTML = "";

  if (data.entries && data.entries.length > 0) {
    data.entries.forEach(entry => {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <h3>${entry.title}</h3>
        <p>${entry.content}</p>
        <small>ID: ${entry.timestamp}</small><br>
        <button class="delete-btn" onclick="deleteEntry('${entry.timestamp}')">Delete</button>
        <button class="edit-btn" onclick="editEntry('${entry.timestamp}', \`${entry.title}\`, \`${entry.content}\`)">Edit</button>
      `;
      container.appendChild(div);
    });
  } else {
    container.innerHTML = "<p>No entries found.</p>";
  }
  updatePagination();
}

async function fetchMessages() {
  const res = await fetch(`/messages?start=${start}`);
  const data = await res.json();
  const container = document.getElementById("dataContainer");
  container.innerHTML = "";

  if (data.messages && data.messages.length > 0) {
    data.messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `
        <h3>${msg.subject}</h3>
        <p>${msg.content}</p>
        <small>From: ${msg.name} (${msg.email})</small><br>
        <small>ID: ${msg.timestamp}</small><br>
        <button class="delete-btn" onclick="deleteMessage('${msg.timestamp}')">Delete</button>
      `;
      container.appendChild(div);
    });
  } else {
    container.innerHTML = "<p>No messages found.</p>";
  }
  updatePagination();
}

function updatePagination() {
  document.getElementById("prevBtn").disabled = start === 0;
  document.getElementById("nextBtn").disabled = currentPage >= totalPages;
  document.getElementById("pageIndicator").textContent =
    `Page ${currentPage} of ${totalPages}`;
}

// Delete entry
async function deleteEntry(id) {
  const fd = new FormData();
  fd.append("action", "delete");
  fd.append("id", id);
  await fetch("/forms", { method: "POST", body: fd });
  await fetchTotalPages();
  if (currentPage > totalPages) { currentPage = totalPages; start = (currentPage-1)*pageSize; }
  fetchEntries();
}

// Delete message
async function deleteMessage(id) {
  const fd = new FormData();
  fd.append("action", "deletemessage");
  fd.append("id", id);
  await fetch("/forms", { method: "POST", body: fd });
  await fetchTotalPages();
  if (currentPage > totalPages) { currentPage = totalPages; start = (currentPage-1)*pageSize; }
  fetchMessages();
}

// Edit modal (entries only)
function editEntry(id, title, content) {
  document.getElementById("editId").value = id;
  document.getElementById("editTitle").value = title;
  document.getElementById("editContent").value = content;
  document.getElementById("editModal").style.display = "flex";
}
function closeEditModal() { document.getElementById("editModal").style.display = "none"; }

document.getElementById("editForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("editId").value;
  const newTitle = document.getElementById("editTitle").value;
  const newContent = document.getElementById("editContent").value;
  const fd = new FormData();
  fd.append("action", "edit"); fd.append("id", id);
  fd.append("title", newTitle); fd.append("content", newContent);
  await fetch("/forms", { method: "POST", body: fd });
  closeEditModal(); fetchEntries();
});

// Upload new entry
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  await fetch("/forms", { method: "POST", body: fd });
  e.target.reset();
  await fetchTotalPages();
  start = 0; currentPage = 1;
  fetchEntries();
});

// Export entries
document.getElementById("exportBtn").addEventListener("click", async () => {
  const res = await fetch("/entries?all=true");
  const data = await res.json();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "entries.json"; a.click();
  URL.revokeObjectURL(url);
});

// Import entries
document.getElementById("importForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fileInput = document.getElementById("importFile");
  if (!fileInput.files.length) return;
  const fd = new FormData();
  fd.append("file", fileInput.files[0]);
  await fetch("/import", { method: "POST", body: fd });
  alert("Entries imported!");
  await fetchTotalPages();
  start = 0; currentPage = 1;
  fetchEntries();
});

// Pagination
document.getElementById("prevBtn").addEventListener("click", () => {
  if (start >= pageSize) { start -= pageSize; currentPage--; loadCurrentView(); }
});
document.getElementById("nextBtn").addEventListener("click", () => {
  if (currentPage < totalPages) { start += pageSize; currentPage++; loadCurrentView(); }
});

function loadCurrentView() {
  if (currentView === "entries") { fetchEntries(); }
  else { fetchMessages(); }
}

// Switch views
document.getElementById("manageEntriesBtn").addEventListener("click", async () => {
  currentView = "entries"; start = 0; currentPage = 1;
  await fetchTotalPages(); fetchEntries();
});
document.getElementById("manageMessagesBtn").addEventListener("click", async () => {
  currentView = "messages"; start = 0; currentPage = 1;
  await fetchTotalPages(); fetchMessages();
});

// Initial load: entries
(async () => {
  await fetchTotalPages();
  await fetchPageServed();
  currentPage = 1;
  fetchEntries();
})();
</script>

</body>
</html>
