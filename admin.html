<!DOCTYPE html>
<html lang="en">
<head>
<title>Blog Admin</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
  box-sizing: border-box;
  font-family: Arial, Helvetica, sans-serif;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
}

/* Top navigation bar */
.topnav {
  overflow: hidden;
  background-color: #333;
}

.topnav a {
  float: left;
  display: block;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

.topnav a:hover {
  background-color: #ddd;
  color: black;
}

/* Content area */
.content {
  background-color: #f9f9f9;
  padding: 20px;
  min-height: 400px;
}

form {
  background: white;
  padding: 15px;
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

form input[type="text"], form textarea {
  width: 100%;
  padding: 8px;
  margin: 8px 0;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* Reusable button style */
.btn-primary {
  padding: 10px 15px;
  background-color: #333;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary:hover {
  background-color: #555;
}

/* Blog entry list */
.entry {
  background: white;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.entry h3 {
  margin: 0;
}

.entry button {
  margin-right: 10px;
  margin-top: 10px;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.delete-btn {
  background-color: #b33;
  color: white;
}

.edit-btn {
  background-color: #337ab7;
  color: white;
}

.delete-btn:hover { background-color: #d44; }
.edit-btn:hover { background-color: #559ed6; }

/* Pagination */
#pagination {
  text-align: center;
  margin-top: 20px;
}

#pagination button {
  margin: 0 5px;
  padding: 8px 14px;
  border: none;
  border-radius: 4px;
  background-color: #333;
  color: white;
  cursor: pointer;
}

#pagination button:disabled {
  background-color: #aaa;
  cursor: not-allowed;
}

#pageIndicator {
  display: block;
  margin-top: 10px;
  font-size: 14px;
  color: #555;
}

/* Footer */
.footer {
  background-color: #ddd;
  padding: 10px;
  text-align: center;
}

/* Modal editor */
#editModal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#editModalContent {
  background: #fff;
  padding: 20px;
  border-radius: 6px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div class="topnav">
  <a href="/">Blog</a>
  <a href="/admin">Admin</a>
  <a href="/shutdown">Off</a>
  <a href="/logout">Logout</a>
</div>

<div class="content">
  <h2>Add New Blog Entry</h2>
  <form id="uploadForm">
    <input type="text" name="title" placeholder="Title" required>
    <textarea name="content" placeholder="Write your post..." rows="5" required></textarea>
    <input type="hidden" name="action" value="upload">
    <button type="submit" class="btn-primary">Upload Entry</button>
  </form>

  <h2>Data Management</h2>
  <button id="exportBtn" class="btn-primary">Export All Entries</button>

  <form id="importForm" enctype="multipart/form-data" style="margin-top:15px;">
    <input type="file" id="importFile" name="file" accept=".json" required>
    <button type="submit" class="btn-primary">Import Entries</button>
WARNING! This will OVERWRITE your current entries.json file. You've been warned.
  </form> 

  <h2>Manage Entries</h2>
  <div id="entries"></div>

  <div id="pagination">
    <button id="prevBtn">Prev</button>
    <button id="nextBtn">Next</button>
    <span id="pageIndicator"></span>
  </div>
</div>

<div class="footer">
  <p>Admin Panel â€¢ Worlds Smallest Blog Server</p>
</div>

<!-- Edit Modal -->
<div id="editModal">
  <div id="editModalContent">
    <h3>Edit Blog Entry</h3>
    <form id="editForm">
      <input type="hidden" name="id" id="editId">
      <input type="text" id="editTitle" placeholder="Title" required>
      <textarea id="editContent" rows="10" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:4px;" required></textarea>
      <div style="text-align:right;">
        <button type="button" onclick="closeEditModal()" class="btn-primary" style="background:#777;">Cancel</button>
        <button type="submit" class="btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
let start = 0;
const pageSize = 5;
let currentPage = 1;
let totalPages = 1;

// fetch total count on startup
async function fetchTotalPages() {
  const response = await fetch("/count");
  const data = await response.json();
  const totalEntries = data.total || 0;
  totalPages = Math.max(1, Math.ceil(totalEntries / pageSize));
}

async function fetchEntries() {
  const response = await fetch(`/entries?start=${start}`);
  const data = await response.json();
  const container = document.getElementById("entries");
  container.innerHTML = "";

  if (data.entries && data.entries.length > 0) {
    data.entries.forEach(entry => {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <h3>${entry.title}</h3>
        <p>${entry.content}</p>
        <small>ID: ${entry.timestamp}</small><br>
        <button class="delete-btn" onclick="deleteEntry('${entry.timestamp}')">Delete</button>
        <button class="edit-btn" onclick="editEntry('${entry.timestamp}', \`${entry.title}\`, \`${entry.content}\`)">Edit</button>
      `;
      container.appendChild(div);
    });
  } else {
    container.innerHTML = "<p>No entries found.</p>";
  }

  // update pagination state
  document.getElementById("prevBtn").disabled = start === 0;
  document.getElementById("nextBtn").disabled = currentPage >= totalPages;

  document.getElementById("pageIndicator").textContent =
    `Page ${currentPage} of ${totalPages}`;
}

// Export
document.getElementById("exportBtn").addEventListener("click", async () => {
  const response = await fetch("/entries?all=true");
  const data = await response.json();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "entries.json";
  a.click();
  URL.revokeObjectURL(url);
});

// Import
document.getElementById("importForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fileInput = document.getElementById("importFile");
  if (!fileInput.files.length) return;

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  await fetch("/import", { method: "POST", body: formData });
  alert("Entries imported!");
  await fetchTotalPages();
  start = 0;
  currentPage = 1;
  fetchEntries();
});

// Delete
async function deleteEntry(id) {
  const formData = new FormData();
  formData.append("action", "delete");
  formData.append("id", id);

  await fetch("/forms", { method: "POST", body: formData });
  await fetchTotalPages();
  if (currentPage > totalPages) {
    currentPage = totalPages;
    start = (currentPage - 1) * pageSize;
  }
  fetchEntries();
}

// Edit modal
function editEntry(id, title, content) {
  document.getElementById("editId").value = id;
  document.getElementById("editTitle").value = title;
  document.getElementById("editContent").value = content;
  document.getElementById("editModal").style.display = "flex";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

document.getElementById("editForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = document.getElementById("editId").value;
  const newTitle = document.getElementById("editTitle").value;
  const newContent = document.getElementById("editContent").value;

  const formData = new FormData();
  formData.append("action", "edit");
  formData.append("id", id);
  formData.append("title", newTitle);
  formData.append("content", newContent);

  await fetch("/forms", { method: "POST", body: formData });
  closeEditModal();
  fetchEntries();
});

// Upload new entry
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);

  await fetch("/forms", { method: "POST", body: formData });
  e.target.reset();
  await fetchTotalPages();
  start = 0;
  currentPage = 1;
  fetchEntries();
});

// Pagination
document.getElementById("prevBtn").addEventListener("click", () => {
  if (start >= pageSize) {
    start -= pageSize;
    currentPage--;
    fetchEntries();
  }
});

document.getElementById("nextBtn").addEventListener("click", () => {
  if (currentPage < totalPages) {
    start += pageSize;
    currentPage++;
    fetchEntries();
  }
});

// Initial load
(async () => {
  await fetchTotalPages();
  currentPage = 1;
  fetchEntries();
})();
</script>

</body>
</html>
